<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/template}"
>
<body>
<div layout:fragment="pageStyles">
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css"/>
    <style>
        .programContent {
            display: flex;
        }

        .left {
            flex: 2;
        }

        .right {
            flex: 1;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr 3fr;
            grid-gap: 10px; /* 셀 사이의 간격 */
            padding: 10px;
        }

        .grid-header {
            background-color: #f2f2f2;
            padding: 10px;
            text-align: left;
        }

        .grid-cell {
            grid-column: span 1; /* 기본적으로 한 열 차지 */
            padding: 10px;
        }

        .searchForm {
            text-align: right;
            padding: 10px;
        }
    </style>
</div>
<div layout:fragment="pageJs">
    <!--    <link rel="stylesheet" href="@{/js/realgrid/realgrid.2.7.2/realgrid-style.css}"-->
    <!--          th:href="@{/js/realgrid/realgrid.2.7.2/realgrid-sky-blue.css}"/>-->
    <!--    <link rel="stylesheet" th:href="@{/css/realgrid/custom.css}"/>-->
    <!--    <script src="/js/realgrid/realgrid.2.7.2/realgrid-lic.js"></script>-->
    <!--    <script src="/js/realgrid/realgrid.2.7.2/realgrid.2.7.2.min.js"></script>-->
    <!--    <script src="/js/realgrid/realgrid.2.7.2/libs/jszip.min.js"></script>-->
    <script src="/js/grid/tuigrid/tui-grid.min.js"></script>
</div>

<div layout:fragment="content">
    <div class="programContent">
        <div class="left">
            <div>
                <div id="searchForm" class="searchForm">
                    <div>
                        <select id="searchType" name="searchType">
                            <option value="">전체</option>
                            <option value="id">ID</option>
                            <option value="programName">프로그램명</option>
                            <option value="url">URL</option>
                        </select>
                        <input type="text" id="searchInput" name="searchInput" value=""/>
                        <input type="button" id="searchBtn" value="검색"/>
                    </div>
                </div>
            </div>
            <div id="grid"></div>
            <div class="pagination">
            </div>
        </div>
        <div class="right">
            <div id="programEditForm" name="programEditForm">
                <input type="text" class="hidden" name="id" id="id"/>
                <div class="grid-container">
                    <div class="grid-header">프로그램명</div>
                    <div class="grid-cell">
                        <input type="text" style="width: 100%;" name="programName" id="programName"/>
                        <div class="field-error-message" data-target="programName"></div>
                    </div>

                    <div class="grid-header">URL</div>
                    <div class="grid-cell">
                        <input type="text" style="width: 100%;" name="url" id="url"/>
                    </div>

                    <div class="grid-header">생성일</div>
                    <div class="grid-cell">
                        <input type="text" style="width: 100%;" name="createdAt" id="createdAt" disabled/>
                    </div>

                    <div class="grid-header">수정일</div>
                    <div class="grid-cell">
                        <input type="text" style="width: 100%;" name="updatedAt" id="updatedAt" disabled/>
                    </div>

                    <div class="grid-header">수정자</div>
                    <div class="grid-cell">
                        <input type="text" style="width: 100%;" name="lastUpdatedByUserLoginId"
                               id="lastUpdatedByUserLoginId" disabled/>
                    </div>
                </div>
                <div class="rightBtnArea">
                </div>
            </div>
        </div>
    </div>
</div>
<div layout:fragment="pageScripts">
    <script th:type="module">
        import {qs, qsAll, createEl, HTTP_STATUS} from "/js/common/util.js";
        import Pagination from "/js/common/Pagination.js";
        import ProgramGrid from "/js/program/admin/manage/ProgramGrid.js";
        import TGrid from "/js/grid/TGrid.js";
        import TGridColumn from "/js/grid/TGridColumn.js";
        import EditForm from "/js/program/admin/manage/EditForm.js";
        import {fetchCreateProgram, fetchDeleteProgram, fetchEditProgram} from "/js/apis/program/program.js";
        import {errorAlert, infoAlert} from "/js/common/alert.js";
        import {FetchError, FieldFetchError} from "/js/error/fetchError.js";

        const tag = '[programManage]';

        class ProgramManageMediator {
            /**
             * @type {ProgramGrid}
             */
            programGrid;
            /**
             * @type {EditForm}
             */
            editForm;

            constructor(programGrid) {
                this.programGrid = programGrid;
                this.editForm = new EditForm({
                    form: qs(document, '#programEditForm'),
                    addBtnCallback: this.#addBtnCallback(),
                    editBtnCallback: this.#editBtnCallback(),
                    delBtnCallback: this.#delBtnCallback(),
                    newBtnCallback: this.#newBtnCallback(),
                });
                this.#init();
            }
            async search() {
                await this.programGrid.search();
            }
            /**
             * @description 프로그램 수정 모드
             * @param {Program} program
             */
            editMode(program) {
                this.editForm.setEditMode(program);
            }

            newMode() {
                this.editForm.setNewMode();
            }

            #init() {
                this.programGrid.setClickEvent(async ({rowNum, columnName}) => {
                    const program = this.programGrid.getProgram(rowNum);

                    if(!program)
                        return;

                    this.editMode(program);
                });
            }

            /**
             * @description 신규 등록 버튼 콜백 생성
             * @return {(function(): void)|*}
             */
            #newBtnCallback() {
                return () => {
                    this.newMode();
                };
            }

            /**
             * @description 추가 버튼 콜백 생성
             * @return {(function(): Promise<void>)|*}
             */
            #addBtnCallback() {
                return async () => {
                    const programName = this.editForm.getProgramName();
                    const url = this.editForm.getUrl();
                    const form = this.editForm.getForm();
                    try {
                        await fetchCreateProgram({programName, url});
                        infoAlert("저장되었습니다.");
                        await this.programGrid.search();
                        this.newMode();
                    } catch (e) {
                        if (e instanceof FetchError) {
                            const fieldFetchError = new FieldFetchError(form, e);
                            if (e.status === HTTP_STATUS.CONFLICT) {
                                errorAlert('이미 등록된 URL입니다.');
                                fieldFetchError.clearMessage(...qsAll(form, '#url'));
                                fieldFetchError.bindingMessage();
                            } else {
                                fieldFetchError.clearMessage(...qsAll(form, 'input[type="text"]'));
                                fieldFetchError.bindingMessage();
                            }
                        } else {
                            errorAlert("저장에 실패하였습니다. 잠시 후 다시 시도해주세요.");
                            throw e;
                        }
                    }
                }
            }

            /**
             * @description 수정 버튼 콜백 생성
             * @return {(function(): Promise<void>)|*}
             */
            #editBtnCallback() {
                return async () => {
                    const form = this.editForm.getForm();
                    const id = this.editForm.getId();
                    const programName = this.editForm.getProgramName();
                    const url = this.editForm.getUrl();

                    try {
                        await fetchEditProgram({id, programName, url})
                        infoAlert("수정되었습니다.");
                        await this.programGrid.search();
                        this.newMode();
                    } catch (e) {
                        if (e instanceof FetchError) {
                            if (e.status === HTTP_STATUS.CONFLICT) {
                                errorAlert('이미 등록된 URL입니다.');
                                const fieldFetchError = new FieldFetchError(form, e);
                                fieldFetchError.clearMessage(...qsAll(form, '#url'));
                                fieldFetchError.bindingMessage();
                            }
                        } else {
                            errorAlert("수정에 실패하였습니다. 잠시 후 다시 시도해주세요.");
                            throw e;
                        }
                    }
                };
            }

            /**
             * @description 삭제 버튼 콜백 생성
             * @return {(function(): Promise<void>)|*}
             */
            #delBtnCallback() {
                return async () => {
                    try {
                        const id = this.editForm.getId();
                        await fetchDeleteProgram(id);
                        infoAlert("삭제되었습니다.");
                        await this.programGrid.search();
                        this.newMode();
                    } catch (e) {
                        errorAlert("삭제에 실패하였습니다. 잠시 후 다시 시도해주세요.");
                        throw e;
                    }
                }
            }

        }

        document.addEventListener('DOMContentLoaded', async () => {
            const TUI_GRID = tui.Grid;
            const container = qs(document, '.programContent');
            const gridWrapper = qs(container, '#grid');
            const searchForm = qs(container, '#searchForm');
            const searchBtn = qs(searchForm, '#searchBtn');
            const searchInput = qs(searchForm, '#searchInput');
            const pagination = new Pagination(qs(container, '.pagination'));
            const tGrid = TGrid.create({
                tuiGrid: TUI_GRID,
                wrapperElement: gridWrapper,
                columns: [
                    TGridColumn.create({name: 'id', header: 'id'}).width(50).end()
                    , TGridColumn.create({name: 'programName', header: '프로그램명'})
                            .alignLeft()
                            .end()
                    , TGridColumn.create({name: 'url', header: 'URL'}).end()
                    , TGridColumn.create({name: 'createdAt', header: '생성일'}).end()
                    , TGridColumn.create({name: 'updatedAt', header: '수정일'}).end()
                    , TGridColumn.create({name: 'lastUpdatedByUserLoginId', header: '수정자'}).end()
                ]
            })
                    .end();
            const programGrid = new ProgramGrid({
                tGrid,
                container,
                searchForm,
                pagination,
            });

            const programManageMediator = new ProgramManageMediator(programGrid);

            await programManageMediator.search();

            searchBtn.addEventListener('click', async () => {
                await programManageMediator.search()
            });
            searchInput.addEventListener('keyup', async (event) => {
                if (event.key === 'Enter')
                    await programManageMediator.search()
            })
        });
    </script>
</div>
</body>


</html>
